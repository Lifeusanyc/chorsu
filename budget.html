<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Vaqtli Balans Dashboard</title>

  <!-- Kutubxonalar -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow-x: hidden;
    }
    canvas.webgl-bg {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <canvas class="webgl-bg"></canvas>

  <div class="max-w-5xl mx-auto space-y-6">
    <h1 class="text-4xl font-bold text-center text-blue-400">üåç Real Vaqtli Balans Dashboard</h1>

    <div class="flex justify-end">
      <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold">‚¨áÔ∏è CSV eksport</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-gray-800 p-6 rounded-2xl space-y-3 shadow-lg">
        <div class="text-xl font-mono">‚è∞ Joriy vaqt: <span id="time" class="text-green-400"></span></div>
        <div class="text-2xl">üí∞ Balans: <span id="balance" class="text-yellow-400 font-bold"></span></div>
      </div>
      <div class="bg-gray-800 p-4 rounded-2xl shadow-lg">
        <canvas id="balanceChart" height="180"></canvas>
      </div>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl shadow-lg">
      <h2 class="text-xl mb-2">üßæ So‚Äònggi balanslar tarixi</h2>
      <ul id="history" class="text-sm font-mono space-y-1 text-gray-300"></ul>
    </div>
  </div>

  <script>
    // üîÅ Ma'lumotlarni boshlash
    let balance = parseFloat(localStorage.getItem("balance")) || 0;
    const incomeRange = { min: 5000, max: 7000 };
    const expenseRange = { min: 4000, max: 5000 };
    const labels = [], incomeData = [], expenseData = [], balanceData = [];
    const history = [];

    // üìä Grafikni yaratish
    const chart = new Chart(document.getElementById('balanceChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: "Kirim",
            data: incomeData,
            borderColor: "rgb(59, 130, 246)",
            backgroundColor: "rgba(59,130,246,0.1)",
            tension: 0.3
          },
          {
            label: "Chiqim",
            data: expenseData,
            borderColor: "rgb(239, 68, 68)",
            backgroundColor: "rgba(239,68,68,0.1)",
            tension: 0.3
          },
          {
            label: "Balans",
            data: balanceData,
            borderColor: "rgb(34, 197, 94)",
            backgroundColor: "rgba(34,197,94,0.1)",
            tension: 0.3
          }
        ]
      },
      options: {
        plugins: {
          zoom: {
            zoom: { wheel: { enabled: true }, mode: 'x' },
            pan: { enabled: true, mode: 'x' }
          }
        },
        scales: { y: { beginAtZero: true } },
        responsive: true
      }
    });

    function update() {
      const income = Math.random() * (incomeRange.max - incomeRange.min) + incomeRange.min;
      const expense = Math.random() * (expenseRange.max - expenseRange.min) + expenseRange.min;
      balance += income - expense;

      // Saqlash
      localStorage.setItem("balance", balance.toFixed(2));

      const now = new Date();
      const timeLabel = now.toLocaleTimeString();

      document.getElementById('time').textContent = now.toLocaleString();
      document.getElementById('balance').textContent = "$" + balance.toFixed(2);

      labels.push(timeLabel);
      incomeData.push(income);
      expenseData.push(expense);
      balanceData.push(balance);

      if (labels.length > 30) {
        labels.shift();
        incomeData.shift();
        expenseData.shift();
        balanceData.shift();
      }

      chart.update();

      history.unshift(`${timeLabel} - Kirim: $${income.toFixed(2)} | Chiqim: $${expense.toFixed(2)} | Balans: $${balance.toFixed(2)}`);
      if (history.length > 10) history.pop();
      document.getElementById("history").innerHTML = history.map(e => `<li>${e}</li>`).join('');
    }

    setInterval(update, 1000);

    function exportCSV() {
      let csv = "Vaqt,Kirim,Chiqim,Balans\n";
      for (let i = 0; i < labels.length; i++) {
        csv += `${labels[i]},${incomeData[i].toFixed(2)},${expenseData[i].toFixed(2)},${balanceData[i].toFixed(2)}\n`;
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      saveAs(blob, "balans_tarixi.csv");
    }

    // üåå Three.js fon animatsiyasi
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector(".webgl-bg") });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const geometry = new THREE.SphereGeometry(1, 32, 32);
    const material = new THREE.MeshStandardMaterial({ color: 0x0077ff, wireframe: true });
    const sphere = new THREE.Mesh(geometry, material);
    scene.add(sphere);

    const light = new THREE.PointLight(0xffffff, 1, 100);
    light.position.set(5, 5, 5);
    scene.add(light);

    camera.position.z = 3;

    function animate() {
      requestAnimationFrame(animate);
      sphere.rotation.x += 0.005;
      sphere.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
